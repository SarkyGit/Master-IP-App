{% extends "base.html" %}

{% block content %}
<h1 class="text-xl mb-4">{{ form_title }}</h1>
<form method="post" id="device-form" class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
  <div>
    <label class="block">Hostname</label>
    <input type="text" name="hostname" value="{{ device.hostname if device else '' }}" class="w-full p-2 text-black" required />
  </div>
  <div>
    <label class="block">IP Address</label>
    <input type="text" name="ip" id="ip-field" value="{{ device.ip if device else '' }}" class="w-full p-2 text-black" />
  </div>
  <div>
    <label class="block">MAC Address</label>
    <input type="text" name="mac" value="{{ device.mac if device else '' }}" class="w-full p-2 text-black" />
  </div>
  <div>
    <label class="block">Asset Tag</label>
    <input type="text" name="asset_tag" value="{{ device.asset_tag if device else '' }}" class="w-full p-2 text-black" />
  </div>
  <div>
    <label class="block">Model</label>
    <input list="model-list" type="text" name="model" value="{{ device.model if device else '' }}" class="w-full p-2 text-black" />
    <datalist id="model-list">
      {% for m in model_list %}
      <option value="{{ m }}">{{ m }}</option>
      {% endfor %}
    </datalist>
  </div>
  <div>
    <label class="block">Serial Number</label>
    <input type="text" name="serial_number" value="{{ device.serial_number if device else '' }}" class="w-full p-2 text-black" />
  </div>
  <div>
    <label class="block">Manufacturer</label>
    <input type="text" name="manufacturer" value="{{ device.manufacturer if device else '' }}" class="w-full p-2 text-black" required />
  </div>
  <div>
    <label class="block">Detected Platform</label>
    <input type="text" name="detected_platform" value="{{ device.detected_platform if device else '' }}" class="w-full p-2 text-black" />
  </div>
  <div>
    <label class="block">Device Type</label>
    <select name="device_type_id" class="w-full p-2 text-black" required>
      <option value="">---</option>
      {% for dt in device_types %}
      <option value="{{ dt.id }}" {% if device and device.device_type_id == dt.id %}selected{% endif %}>{{ dt.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label class="block">Location</label>
    <select name="location_id" class="w-full p-2 text-black">
      <option value="">---</option>
      {% for loc in locations %}
      <option value="{{ loc.id }}" {% if device and device.location_id == loc.id %}selected{% endif %}>{{ loc.name }} ({{ loc.location_type }})</option>
      {% endfor %}
    </select>
  </div>
  {% if device %}
  <div>
    <label class="block">Status</label>
    <select name="status" class="w-full p-2 text-black">
      <option value="">---</option>
      {% for st in status_options %}
      <option value="{{ st }}" {% if device and device.status == st %}selected{% endif %}>{{ st }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label class="block">VLAN <span id="vlan-suggestion" class="ml-2 text-sm text-green-400"></span></label>
    <select name="vlan_id" id="vlan-field" class="w-full p-2 text-black">
      <option value="">---</option>
      {% for vlan in vlans %}
      <option value="{{ vlan.id }}" {% if device and device.vlan_id == vlan.id %}selected{% endif %}>{{ vlan.tag }} - {{ vlan.description or '' }}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}
  <div>
    <label class="block">SSH Profile</label>
    <select name="ssh_credential_id" class="w-full p-2 text-black">
      <option value="">---</option>
      {% for cred in ssh_credentials %}
      <option value="{{ cred.id }}" {% if device and device.ssh_credential_id == cred.id %}selected{% endif %}>{{ cred.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label class="block">SNMP Profile</label>
    <select name="snmp_community_id" class="w-full p-2 text-black">
      <option value="">---</option>
      {% for snmp in snmp_communities %}
      <option value="{{ snmp.id }}" {% if device and device.snmp_community_id == snmp.id %}selected{% endif %}>{{ snmp.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label class="inline-flex items-center">
      <input type="checkbox" name="on_lasso" value="1" class="mr-2" {% if device and device.on_lasso %}checked{% endif %}>
      On Lasso
    </label>
  </div>
  <div>
    <label class="inline-flex items-center">
      <input type="checkbox" name="on_r1" value="1" class="mr-2" {% if device and device.on_r1 %}checked{% endif %}>
      On R1
    </label>
  </div>
  <div>
    <label class="block">Site</label>
    <select name="site_id" class="w-full p-2 text-black">
      <option value="">-- None --</option>
      {% for site in sites %}
      <option value="{{ site.id }}" {% if device and device.site_id == site.id %}selected{% endif %}>{{ site.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label class="block">Config Pull Interval</label>
    <select name="config_pull_interval" class="w-full p-2 text-black">
      {% for opt in ['none','hourly','daily','weekly'] %}
      <option value="{{ opt }}" {% if device and device.config_pull_interval == opt %}selected{% endif %}>{{ opt.title() }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="md:col-span-2">
    <button type="submit" class="bg-blue-600 px-4 py-2">Submit</button>
    <a href="/devices" class="ml-2 underline">Cancel</a>
  </div>
</form>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const ipField = document.getElementById('ip-field');
  const vlanField = document.getElementById('vlan-field');
  const note = document.getElementById('vlan-suggestion');
  const manuField = document.querySelector('input[name="manufacturer"]');
  const r1Box = document.querySelector('input[name="on_r1"]').closest('div');
  const form = document.getElementById('device-form');

  function toggleR1() {
    if (!manuField) return;
    const show = manuField.value.trim().toLowerCase() === 'ruckus';
    r1Box.style.display = show ? 'block' : 'none';
    if (!show) {
      r1Box.querySelector('input').checked = false;
    }
  }
  toggleR1();
  manuField.addEventListener('input', toggleR1);
  
  async function fetchSuggestion() {
    const ip = ipField.value.trim();
    if (!ip) return;
    try {
      const res = await fetch(`/api/suggest-vlan?ip=${encodeURIComponent(ip)}`);
      if (!res.ok) return;
      const data = await res.json();
      if (vlanField) {
        if (data.suggested_vlan_id) {
          vlanField.value = data.suggested_vlan_id;
          note.textContent = `VLAN ${data.suggested_vlan_id} suggested based on IP`;
        } else if (data.label) {
          note.textContent = data.label;
        } else {
          note.textContent = '';
        }
      }
    } catch (err) {
      console.error('suggest-vlan', err);
    }
  }

  if (vlanField) {
    ipField.addEventListener('change', fetchSuggestion);
    ipField.addEventListener('blur', fetchSuggestion);
  }

  form.addEventListener('submit', function(e) {
    const missing = [];
    const assetTag = form.querySelector('input[name="asset_tag"]').value.trim();
    const ip = ipField.value.trim();
    const mac = form.querySelector('input[name="mac"]').value.trim();
    if (!assetTag) missing.push('Asset Tag');
    if (!ip) missing.push('IP Address');
    if (!mac) missing.push('MAC Address');
    if (missing.length) {
      if (!confirm('Submit device with missing ' + missing.join(', ') + '?')) {
        e.preventDefault();
      }
    }
  });
});
</script>
{% endblock %}
