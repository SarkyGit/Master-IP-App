{% extends "base.html" %}

{% block content %}
<h1 class="text-xl mb-4">Devices</h1>
{% if current_user and current_user.role in ['editor','admin','superadmin'] %}
  <a href="/devices/new" class="underline">Add Device</a>
{% endif %}
{% if current_user and current_user.role == 'superadmin' %}
  <form method="post" action="/admin/run-push-queue" style="display:inline">
    <button type="submit" class="ml-2">ðŸ”„ Run Push Queue Now</button>
  </form>
{% endif %}
<form method="post" action="/devices/bulk-delete">
<table class="min-w-full bg-black">
  <thead>
    <tr>
      <th class="px-2"><input type="checkbox" id="select-all"></th>
      <th class="px-4 py-2 text-left">Hostname</th>
      <th class="px-4 py-2 text-left">IP</th>
      <th class="px-4 py-2 text-left">MAC</th>
      <th class="px-4 py-2 text-left">Asset Tag</th>
      <th class="px-4 py-2 text-left">Model</th>
      <th class="px-4 py-2 text-left">Manufacturer</th>
      <th class="px-4 py-2 text-left">Serial</th>
      <th class="px-4 py-2 text-left">Location</th>
      <th class="px-4 py-2 text-left">On Lasso</th>
      <th class="px-4 py-2 text-left">On R1</th>
      <th class="px-4 py-2 text-left">Type</th>
      <th class="px-4 py-2 text-left">Status</th>
      <th class="px-4 py-2 text-left">VLAN</th>
      <th class="px-4 py-2 text-left">SSH Profile</th>
      <th class="px-4 py-2 text-left">SNMP Profile</th>
      {% if current_user and current_user.role in ['editor','admin','superadmin'] %}
      <th></th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
  {% for device in devices %}
    <tr class="border-t border-white">
      <td class="px-2"><input type="checkbox" name="selected" value="{{ device.id }}"></td>
      <td class="px-4 py-2">{{ device.hostname }}</td>
      <td class="px-4 py-2 {% if device.ip and duplicate_ips.get(device.ip) %}duplicate{% endif %}" title="{{ duplicate_ips.get(device.ip)|join(', ') if duplicate_ips.get(device.ip) }}">{{ device.ip }}</td>
      <td class="px-4 py-2 {% if device.mac and duplicate_macs.get(device.mac) %}duplicate{% endif %}" title="{{ duplicate_macs.get(device.mac)|join(', ') if duplicate_macs.get(device.mac) }}">{{ device.mac or '' }}</td>
      <td class="px-4 py-2 {% if device.asset_tag and duplicate_tags.get(device.asset_tag) %}duplicate{% endif %}" title="{{ duplicate_tags.get(device.asset_tag)|join(', ') if duplicate_tags.get(device.asset_tag) }}">{{ device.asset_tag or '' }}</td>
      <td class="px-4 py-2">{{ device.model or '' }}</td>
      <td class="px-4 py-2">{{ device.manufacturer }}</td>
      <td class="px-4 py-2">{{ device.serial_number or '' }}</td>
      <td class="px-4 py-2">{{ device.location_ref.name if device.location_ref else '' }}</td>
      <td class="px-4 py-2">{{ 'âœ”' if device.on_lasso else '' }}</td>
      <td class="px-4 py-2">{{ 'âœ”' if device.on_r1 else '' }}</td>
      <td class="px-4 py-2">{{ device.device_type.name if device.device_type else '' }}</td>
      <td class="px-4 py-2">{{ device.status or '' }}</td>
      <td class="px-4 py-2">{{ device.vlan.tag if device.vlan else '' }}</td>
      <td class="px-4 py-2">{{ device.ssh_credential.name if device.ssh_credential else '' }}</td>
      <td class="px-4 py-2">{{ device.snmp_community.name if device.snmp_community else '' }}</td>
      {% if current_user and current_user.role in ['editor','admin','superadmin'] %}
      <td class="px-4 py-2">
        <a href="/devices/{{ device.id }}/edit" class="text-blue-400 underline mr-2">Edit</a>
        <form method="post" action="/devices/{{ device.id }}/delete" style="display:inline">
          <button type="submit" class="text-red-400 underline" onclick="return confirm('Delete device?')">Delete</button>
        </form>
        <form method="post" action="/devices/{{ device.id }}/pull-config" style="display:inline">
          <button type="submit" class="text-green-400 underline ml-2">Pull Config</button>
        </form>
        <a href="/devices/{{ device.id }}/push-config" class="text-purple-400 underline ml-2">Push Config</a>
        <a href="/devices/{{ device.id }}/configs" class="text-yellow-400 underline ml-2">Configs</a>
        {% if device.snmp_community %}
        <a href="/devices/{{ device.id }}/ports" class="text-indigo-400 underline ml-2">Port Status</a>
        {% endif %}
      </td>
      {% endif %}
    </tr>
  {% endfor %}
  </tbody>
</table>
<button type="submit" class="mt-2 bg-red-600 px-3 py-1">Delete Selected</button>
</form>
<script>
document.getElementById('select-all').addEventListener('change', function(e){
  document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = e.target.checked);
});
</script>
{% endblock %}
