<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>{% block title %}CEST Master IP Tool{% endblock %}</title>
    {% set theme = (current_user.theme if current_user else 'dark_colourful') if current_user is defined else 'dark_colourful' %}
    {% set font = (current_user.font if current_user else 'sans') if current_user is defined else 'sans' %}
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/layout.css') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='themes/' ~ theme ~ '.css') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='fonts/' ~ font ~ '.css') }}">
    <link rel='stylesheet' href='{{ request.url_for('static', path='css/unocss.css') }}'>
  </head>
  <body>
    <header>
      <div class="top-header">
        <div class="container mx-auto flex items-center justify-between">
          <div class="logo-box flex items-center">
            {% if logo_url() %}
            <img src="{{ logo_url() }}" alt="Logo" class="h-10 mr-2" />
            {% endif %}
            <span class="text-[var(--btn-text)] text-base">CEST Master IP and Config Tool</span>
            {% if current_user and current_user.role == 'superadmin' %}
            <a href="/admin/logo" class="ml-2 underline text-sm">Upload Logo</a>
            {% endif %}
          </div>
          <div class="login-area flex items-center space-x-2">
            {% if current_user %}
            <div class="relative" x-data="{open:false}">
              <button @click="open = !open" class="block px-4 py-2 text-[var(--btn-text)] bg-[var(--btn-bg)] hover:bg-[var(--btn-hover)] rounded transition">My Profile</button>
              <ul x-show="open" @click.away="open = false" class="absolute right-0 mt-2 bg-[var(--card-bg)] text-[var(--btn-text)] py-2 w-48" x-cloak>
                <li><a class="block px-4 py-2 hover:bg-[var(--btn-hover)]" href="/users/me">View Profile</a></li>
                <li><a class="block px-4 py-2 hover:bg-[var(--btn-hover)]" href="/user/ssh">SSH Profiles</a></li>
              </ul>
            </div>
            {% if current_user.role in ['admin','superadmin'] %}
            {% if current_user.role == 'superadmin' %}
            {% set admin_items = [
              {'label':'Tunables','href':'/tunables'},
              {'label':'SSH Credentials','href':'/admin/ssh'},
              {'label':'SNMP Credentials','href':'/admin/snmp'},
              {'label':'Device Types','href':'/device-types'},
              {'label':'Tag Manager','href':'/admin/tags'},
              {'label':'Locations','href':'/admin/locations'},
              {'label':'Device Import','href':'/bulk/device-import'},
              {'label':'Audit Log','href':'/admin/audit'},
              {'label':'IP Bans','href':'/admin/ip-bans'},
              {'label':'User Management','href':'/admin/users'},
              {'label':'Debug Logs','href':'/admin/debug'}
            ] %}
            {% else %}
            {% set admin_items = [
              {'label':'SSH Credentials','href':'/admin/ssh'},
              {'label':'SNMP Credentials','href':'/admin/snmp'},
              {'label':'Device Types','href':'/device-types'},
              {'label':'Locations','href':'/admin/locations'},
              {'label':'Device Import','href':'/bulk/device-import'}
            ] %}
            {% endif %}
            <div id="admin-menu" class="px-4 py-2 text-[var(--btn-text)] bg-[var(--btn-bg)] hover:bg-[var(--btn-hover)] rounded transition mr-2" data-admin-menu data-label="{{ 'Super Admin' if current_user.role == 'superadmin' else 'Admin' }}" data-items='{{ admin_items|tojson }}'></div>
            {% endif %}
            <a href="/auth/logout" class="block px-4 py-2 text-[var(--btn-text)] bg-[var(--btn-bg)] hover:bg-[var(--btn-hover)] rounded transition logged-in">Logout</a>
            {% else %}
            <a href="/auth/login" class="block px-4 py-2 text-[var(--btn-text)] bg-[var(--btn-bg)] hover:bg-[var(--btn-hover)] rounded transition logged-out">Login</a>
            {% endif %}
          </div>
        </div>
      </div>
      {% block nav %}
      <nav x-data="tabsNav()" class="bg-[var(--nav-bg)] text-[var(--nav-text)] p-2">
        <div class="container mx-auto">
          <div class="flex items-center justify-between">
            <button @click="mobile = !mobile" class="lg:hidden p-2 rounded">â˜°</button>
            <div :class="mobile ? 'flex flex-col space-y-2' : 'hidden lg:flex space-x-4 w-full'">
              {% if current_user %}
              <button @click="activeTopMenu = 'inventory'" class="rounded-t-lg border border-[var(--border-color)] border-b-0 px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] transition">Inventory</button>
              <button @click="activeTopMenu = 'network'" class="rounded-t-lg border border-[var(--border-color)] border-b-0 px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] transition">Network</button>
              <button @click="activeTopMenu = 'tasks'" class="rounded-t-lg border border-[var(--border-color)] border-b-0 px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] transition">Tasks</button>
              <button @click="activeTopMenu = 'reports'" class="rounded-t-lg border border-[var(--border-color)] border-b-0 px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] transition">Reports</button>
              {% if current_user.role in ['editor','admin','superadmin'] %}
              <button @click="activeTopMenu = 'bulk'" class="rounded-t-lg border border-[var(--border-color)] border-b-0 px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] transition">Bulk Add</button>
              {% endif %}
              <button @click="activeTopMenu = 'ssh'" class="ml-auto rounded-t-lg border border-[var(--border-color)] border-b-0 px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] transition">SSH</button>
              {% endif %}
            </div>
          </div>
          <div class="space-y-4 mt-1">
            <div x-show="activeTopMenu == 'inventory'" class="border border-[var(--border-color)] border-t-0 rounded-b-lg bg-[var(--submenu-bg)] text-[var(--submenu-text)] px-4 py-3" x-cloak>
              <div :class="mobile ? 'flex flex-col space-y-2' : 'flex space-x-2'">
                <a href="/devices" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">All Devices</a>
                {% for dtype in get_device_types() %}
                <a href="/devices/type/{{ dtype.id }}" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">{{ dtype.name }}</a>
                {% endfor %}
                <a href="/inventory/audit" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Audit</a>
                <a href="/inventory/trailers" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Trailer Inventory</a>
                <a href="/inventory/sites" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Site Inventory</a>
              </div>
            </div>
            <div x-show="activeTopMenu == 'network'" class="border border-[var(--border-color)] border-t-0 rounded-b-lg bg-[var(--submenu-bg)] text-[var(--submenu-text)] px-4 py-3" x-cloak>
              <div :class="mobile ? 'flex flex-col space-y-2' : 'flex space-x-2'">
                <a href="/network/ip-search" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">IP Search</a>
                <a href="/vlans" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">VLAN MGMT</a>
                <a href="/network/port-configs" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Port Configs</a>
              </div>
            </div>
            <div x-show="activeTopMenu == 'tasks'" class="border border-[var(--border-color)] border-t-0 rounded-b-lg bg-[var(--submenu-bg)] text-[var(--submenu-text)] px-4 py-3" x-cloak>
              <div :class="mobile ? 'flex flex-col space-y-2' : 'flex space-x-2'">
                <a href="/tasks" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Task Queue</a>
                <a href="/devices/duplicates" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Duplicate Checker</a>
                {% if current_user.role in ['admin','superadmin'] %}
                <a href="/tasks/edit-tags" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Edit Tags</a>
                <a href="/tasks/google-sheets" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Google Sheets</a>
                {% endif %}
              </div>
            </div>
            <div x-show="activeTopMenu == 'reports'" class="border border-[var(--border-color)] border-t-0 rounded-b-lg bg-[var(--submenu-bg)] text-[var(--submenu-text)] px-4 py-3" x-cloak>
              <div :class="mobile ? 'flex flex-col space-y-2' : 'flex space-x-2'">
                <a href="/reports/vlan-usage" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">VLAN Usage</a>
              </div>
            </div>
            {% if current_user.role in ['editor','admin','superadmin'] %}
            <div x-show="activeTopMenu == 'bulk'" class="border border-[var(--border-color)] border-t-0 rounded-b-lg bg-[var(--submenu-bg)] text-[var(--submenu-text)] px-4 py-3" x-cloak>
              <div :class="mobile ? 'flex flex-col space-y-2' : 'flex space-x-2'">
                <a href="/bulk/device-import" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Bulk Add Devices</a>
              </div>
            </div>
            {% endif %}
            <div x-show="activeTopMenu == 'ssh'" class="border border-[var(--border-color)] border-t-0 rounded-b-lg bg-[var(--submenu-bg)] text-[var(--submenu-text)] px-4 py-3" x-cloak>
              <div :class="mobile ? 'flex flex-col space-y-2' : 'flex space-x-2'">
                <a href="/ssh/port-config" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Port Config</a>
                <a href="/ssh/port-check" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Port Check</a>
                <a href="/ssh/config-check" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Config Check</a>
                <a href="/ssh/port-search" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Port Search</a>
                <a href="/ssh/bulk-port-update" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Bulk Port Update</a>
                <a href="/bulk/vlan-push" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">VLAN Bulk Push</a>
                <a href="/ssh/netbird-connect" class="px-4 py-2 text-[var(--tab-text)] bg-[var(--tab-bg)] hover:bg-[var(--tab-hover)] rounded-t-lg transition">Initiate Netbird Connection</a>
              </div>
            </div>
          </div>
        </div>
        <script>
          function tabsNav() {
            return {
              mobile: false,
              activeTopMenu: ''
            }
          }
        </script>
      </nav>
      {% endblock %}
    </header>
    <div class="container mt-4">
      <a href="javascript:history.back()" class="block px-4 py-2 text-[var(--btn-text)] bg-[var(--btn-bg)] hover:bg-[var(--btn-hover)] rounded transition">&laquo; Back</a>
      <p class="text-base text-[var(--card-text)]">{{ message }}</p>
      {% block content %}{% endblock %}
    </div>
    <script src="{{ request.url_for('static', path='js/alpine.min.js') }}" defer></script>
    <script type="module" src="{{ request.url_for('static', path='js/bundle.js') }}"></script>
    {% block extra_scripts %}{% endblock %}
  </body>
</html>
